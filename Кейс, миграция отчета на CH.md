## Кейс: Переработка аналитического отчета "План-Факт" с миграцией на ClickHouse

### **Проблема**

Ключевой отчет "План-Факт", используемый для контроля KPI одного из стратегически значимых подразделений компании, столкнулся с серьезными проблемами масштабируемости и надежности по мере роста бизнеса и объема данных. Основные проблемы включали:

- **Сложность поддержки и развития:** Логика, реализованная через большое количество ручных формул, делала внесение изменений рискованным и трудоемким.
- **Ненадежность данных:** Частые расхождения приводили к недоверию к данным со стороны бизнеса.
- **Низкая производительность:** Длительный пересчет данных (более 2 часов) замедлял работу аналитиков и менеджеров, снижая операционную эффективность.
- **Ограниченная гибкость:** Добавление новых метрик или изменение существующих требовало серьезной переработки отчета.

### **Задача**

Требовалось спроектировать и реализовать новое, надежное, производительное и гибкое решение для отчета "План-Факт", полностью устранив проблемы существующей реализации. Необходимо было обеспечить стандартизированный доступ к данным и возможность их дальнейшей визуализации с помощью современных BI-инструментов, сохранив при этом возможность использования привычных пользовательских инструментов (например, Excel) для анализа.

### **Решение и Реализация**

Предложенное решение заключалось в переносе центрального хранилища данных в высокопроизводительную аналитическую базу данных ClickHouse и построении на ее основе единой "витрины данных".

**Процесс и Мои Действия:**

1. **Анализ и проектирование:** Провел детальный анализ логики существующего отчета, выявил все источники данных и зависимости. Важной частью была работа с бизнес-пользователями для уточнения их реальных потребностей и требований.
2. **Архитектура данных:** Спроектировал структуру хранения данных в ClickHouse. Разработал стандартизированную "широкую" витрину данных с месячной гранулярностью, объединяющую планы, факты и затраты по всем необходимым измерениям.
3. **Построение пайплайнов сбора и обработки данных:** Разработал и автоматизировал процессы сбора и обработки данных из различных источников:
    - Фактические данные продаж уже поступали в ClickHouse.
    - Данные по затратам (например, отзывы за баллы, хранение), поступающие в виде Excel-файлов, обрабатывались парсерами на Python и загружались в отдельные таблицы в ClickHouse с оркестрацией через Apache Airflow.
    - Данные по планам продаж загружались Python-скриптом с разработанной логикой для корректного маппинга планов с уровня SKU на уровень бренда.
    - Всю логику трансформации данных и расчета ключевых метрик (Товарооборот, Валовая прибыль, Рентабельность, ДРР и др.) перенес из формул Excel в SQL-запрос при построении витрины данных в ClickHouse, централизовав бизнес-правила.
4. **Обеспечение качества данных:** Внедрил механизмы контроля качества на этапах обработки данных, включая использование контрольных сумм, проверки на дубликаты и выборочные проверки.
5. **Визуализация и доступ:** Настроил подключение к финальной витрине данных из BI-инструмента Apache Superset для построения дашбордов, а также сохранил возможность подключения через ODBC/Power Query для пользователей Excel/Google Sheets.

**Использованные технологии:**

- **База данных:** ClickHouse
- **Языки программирования:** Python, SQL
- **Оркестрация:** Apache Airflow
- **Обработка данных:** Power Query
- **Визуализация:** Apache Superset, Excel/Power Pivot

### **Результаты**

- **Успешно перенесена центральная логика аналитического отчета в высокопроизводительную БД ClickHouse**, заложив основу для повышения надежности и масштабируемости.
- **Повышение надежности данных:** Единый источник истины в БД и автоматизированные процессы снижают вероятность ошибок и расхождений.
- **Улучшение поддерживаемости:** Логика в SQL и управляемые через Airflow процессы упрощают версионирование, тестирование и изменение по сравнению с предыдущей системой.
- **Значительное повышение производительности**: Время обновления отчета сокращено **с более 2 часов до 5 минут** за счет оптимизации запросов и архитектуры в ClickHouse.
- **Увеличение гибкости:** Упрощено добавление новых метрик или разрезов на уровне витрины или BI-инструмента.

Этот проект демонстрирует опыт полного цикла работы с данными: от анализа проблем в существующей системе и сбора требований до проектирования архитектуры, реализации процессов сбора и обработки данных и построения витрины данных для аналитики и визуализации.
